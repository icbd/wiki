---
layout: post
title:  iptables 笔记  
date:   2018-12-03
categories: iptables
---

## 网络七层协议:
 
 * 应用层
 * 表示层
 * 会话层
 * 传输层
 * 网络层
 * 数据链路层
 * 物理层
 
iptable 是一个配置 Linux 内核防火墙的命令行工具, 工作在网络层.

## ip packets

![/wiki/wiki/ip-datagram.jpg](/wiki/wiki/ip-datagram.jpg)

Example:

```text
                                  
    0                   1                   2                   3   
    0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |Ver= 4 |IHL= 5 |Type of Service|       Total Length = 472      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |     Identification = 111      |Flg=0|     Fragment Offset = 0 |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |   Time = 123  | Protocol = 6  |        header checksum        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                         source address                        |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                      destination address                      |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                             data                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |                             data                              |
   \                                                               \
   \                                                               \
   |                             data                              |
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
   |             data              |                                
   +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+                                

```

ip packets 头信息中包含 Protocol Numbers, 标记了上层协议的类型. 所以 iptables 不需要解包也能判断传输层类型.

常用协议号:

|Protocol Number|Protocol|
|---|---|
|1|ICMP|
|6|TCP|
|17|UDP|

所有的协议对照表可以查看文件: `/etc/protocols` .


## iptables

iptables 包含几个概念: 表, 链, 规则, 允许用户定义 链和规则.

### Tables 表

 * filter : 默认表
 * nat : 用于网络地址转换, 如端口转发
 * mangle : 用于特定数据包的修改
 * security : 用于强制访问控制的网络规则, 如 SELinux
 * raw : 用于配置数据包, raw 中的数据不会被系统跟踪
 
### Chains 链

表由链组成, 链是一些按顺序排列的规则的列表. 

filter table: INPUT, OUTPUT, FORWARD
nat table: PREROUTING, POSTROUTING, OUTPUT

用户可以向链中添加自定义规则, 默认规则总在链的最后生效. 

### Rules 规则

数据包的过滤基于规则.

## manipulation

| 命令 命令简写 | 解释 |
| --- | --- |
| --append  -A chain | 将规则添加到链 |
| --check   -C chain | 检查该规则是否在该链上 |
| --delete  -D chain | 从链中删除匹配的规则 |
| --delete  -D chain rulenum | 从链中删除指定规则号位置的规则 |
| --insert  -I chain [rulenum] | 在链中指定规则号的位置, 插入规则 |
| --replace -R chain rulenum | 在链中指定规则号的位置, 替换规则 |
| --list    -L [chain [rulenum]] | 列出所有规则 |
| --list-rules -S [chain [rulenum]] | 打印所有规则 |
| --flush   -F [chain] | 删除所有规则 |
| --zero    -Z [chain [rulenum]] | 归零 |
| --new     -N chain |	新建用户自定义链 |
| --delete-chain -X [chain]	| 删除用户自定链 |
| --policy  -P chain target | 修改链的策略 |
| --rename-chain -E old-chain new-chain | 修改链名(移除依赖) |

注意: 规则号从1开始, 每次操作完规则号刷新

| 选项 | 解释 |
| --- | --- |
| --ipv4	-4 | Nothing |
| --ipv6	-6 | Error |
| [!] --protocol	-p proto	| 指定协议名或协议号 |
| [!] --source	-s address[/mask][...] | 指定来源 | 
| [!] --destination -d address[/mask][...] | 指定目的 |
| [!] --in-interface -i input name[+] | 入口名 ([+] for wildcard) |
| --jump	-j target | 跳转到目标, 执行完return (may load target extension) |
| --goto      -g chain | 跳转到目标, 执行完不return |
| --match	-m match | 延伸匹配 (may load extension) |
| --numeric	-n | 数字格式的输出地址和端口 |
| [!] --out-interface -o output name[+] | 网络接口名 ([+] for wildcard) |
| --table	-t table | 指定要操作的表, 默认为 filter |
| --verbose	-v | 详情模式 |
| --wait	-w [seconds] | 等待 xtables 锁 |
| --line-numbers | 打印规则号 |
| --exact	-x	| expand numbers (display exact values) |
| [!] --fragment	-f	|	match second or further fragments only |
| --modprobe=<command> | try to insert modules using this command |
| --set-counters | PKTS BYTES	set the counter during insert/append |
| [!] --version	-V	|	print package version. |

